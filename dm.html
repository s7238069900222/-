
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DM 門診流程（Step-based）＋健保核對</title>
  <style>
    :root{
      --bg:#f7f1e3;          /* 淺米色底 */
      --card:#fffaf0;
      --ink:#1f2937;
      --muted:#6b7280;
      --line:rgba(31,41,55,.14);
      --shadow:0 12px 30px rgba(31,41,55,.08);
      --radius:18px;
      --ok:#0a7a3d;
      --warn:#b45309;
      --bad:#b91c1c;
      --chip:#ffffff;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      color:var(--ink);
      background:var(--bg);
    }
    header, main{ max-width:1200px; margin:0 auto; padding:18px; }
    header h1{ margin:0 0 6px; font-size:20px; }
    .muted{ color:var(--muted); line-height:1.6; }
    .topbar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:10px; }
    .nav a{
      display:inline-block; padding:8px 10px; border-radius:12px;
      border:1px solid var(--line); background:#fff; color:var(--ink); text-decoration:none;
    }
    .nav a:hover{ opacity:.86; }

    .grid{ display:grid; grid-template-columns: 1.05fr .95fr; gap:14px; margin-top:14px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .sectionTitle{ font-weight:800; margin:0 0 10px; font-size:14px; letter-spacing:.2px; }
    .formRow{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px; }
    @media (max-width: 520px){ .formRow{ grid-template-columns: 1fr; } }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input[type="number"], select{
      width:100%; padding:10px 10px; border-radius:12px;
      border:1px solid var(--line); background:white; font-size:14px; outline:none;
    }
    input[type="checkbox"]{ transform: translateY(1px); }

    .checkboxRow{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 10px; border:1px solid var(--line); background:#fff;
      border-radius:12px; margin-bottom:10px;
    }
    .checkboxRow b{ font-size:13px; }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding:7px 10px; border-radius:999px;
      border:1px solid var(--line); background:var(--chip); font-size:13px;
    }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    button{
      padding:10px 12px; border-radius:12px; border:1px solid var(--line);
      background:white; cursor:pointer; font-weight:700;
    }
    button.primary{ background:#111827; color:white; border-color:#111827; }
    button:hover{ opacity:.92; }

    .tableWrap{ overflow:auto; border-radius:16px; border:1px solid var(--line); background:#fff; }
    table{ width:100%; border-collapse:collapse; min-width:900px; }
    th, td{ border-bottom:1px solid rgba(31,41,55,.08); padding:12px 12px; vertical-align:top; font-size:14px; }
    th{ text-align:left; background:rgba(17,24,39,.04); font-size:13px; color:#111827; position:sticky; top:0; }

    .status{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; border:1px solid var(--line);
      font-weight:800; font-size:12px; white-space:nowrap;
    }
    .ok{ color:var(--ok); border-color:rgba(10,122,61,.22); background:rgba(10,122,61,.06); }
    .warn{ color:var(--warn); border-color:rgba(180,83,9,.22); background:rgba(180,83,9,.06); }
    .bad{ color:var(--bad); border-color:rgba(185,28,28,.22); background:rgba(185,28,28,.06); }

    .small{ font-size:12px; color:var(--muted); line-height:1.6; }
    code{ background:rgba(17,24,39,.06); padding:2px 6px; border-radius:8px; }
    hr.sep{ border:none;border-top:1px solid rgba(31,41,55,.10); margin:12px 0; }

    .flowBox{
      border:1px solid var(--line);
      background:#fff;
      border-radius:16px;
      padding:12px;
    }
    .flowStep{
      border:1px dashed rgba(31,41,55,.22);
      border-radius:14px;
      padding:10px 10px;
      margin:8px 0;
      background:rgba(247,241,227,.55);
    }
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(31,41,55,.18);
      background:#fff;
      font-size:12px;
      margin-right:6px;
      white-space:nowrap;
    }
    .inlineHint{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(31,41,55,.12);
      background:rgba(17,24,39,.03);
    }
    .hidden{ display:none; }
  </style>
</head>

<body>
<header>
  <h1>DM 門診流程版（你的 Step 1→4）＋健保核對</h1>
  <div class="muted">
    門檻固定：Step2（A1c &gt;7 且 ≥3月）、Step3（A1c &gt;7.5 且 ≥6月）、Step4（A1c &gt;8 且 ≥6月）。<br/>
    Metformin maximum 固定：<b>≥1000 mg/day</b>（你的門診定義）＋會同時提醒 <b>eGFR 限制</b>。
  </div>
  <div class="topbar">
    <div class="nav">
      <a href="index.html">回首頁</a>
      <a href="htn.html">HTN</a>
      <a href="lipid.html">Lipid</a>
    </div>
  </div>
</header>

<main class="grid">
  <!-- 左：輸入 -->
  <section class="card">
    <div class="sectionTitle">① 基本資料（流程判斷用）</div>

    <div class="formRow">
      <div>
        <label>HbA1c（%）（目前/第 X 個月）</label>
        <input id="a1c" type="number" min="4" max="20" step="0.1" placeholder="例：8.2">
      </div>
      <div>
        <label>本階段已治療多久（月）</label>
        <input id="monthsOnStage" type="number" min="0" max="60" step="1" placeholder="例：3 或 6">
      </div>
    </div>

    <div class="formRow">
      <div>
        <label>eGFR（用於 Metformin / SGLT2 適用性提醒）</label>
        <input id="egfr" type="number" min="1" max="200" step="1" placeholder="例：42">
      </div>
      <div>
        <label>Metformin 每日總劑量（mg/day）</label>
        <input id="metDose" type="number" min="0" max="3000" step="250" placeholder="例：1000">
        <div class="small">你的流程：<b>≥1000 mg/day</b> 視為 maximum（仍會顯示 eGFR 限制提醒）。</div>
      </div>
    </div>

    <div class="formRow">
      <div>
        <label>SGLT2 品項（若未用可不選）</label>
        <select id="sglt2Agent">
          <option value="none" selected>未使用 / 不評估</option>
          <option value="empa">Empagliflozin</option>
          <option value="dapa">Dapagliflozin</option>
          <option value="cana">Canagliflozin</option>
          <option value="ertu">Ertugliflozin</option>
          <option value="combo45">SGLT2+Metformin 複方（多數仿單需 eGFR ≥45）</option>
        </select>
      </div>
      <div>
        <label>目前口服「成分」數（複方算兩種）</label>
        <input id="oralComponents" type="number" min="0" max="10" step="1" placeholder="例：3">
        <div class="small">健保：口服成分原則 ≤4。</div>
      </div>
    </div>

    <div class="checkboxRow">
      <input id="ckd" type="checkbox">
      <div>
        <b>CKD/蛋白尿風險</b>
        <div class="small">你流程：CKD/蛋白尿/HF → Step2 優先 SGLT2。</div>
      </div>
    </div>

    <div class="checkboxRow">
      <input id="hf" type="checkbox">
      <div>
        <b>心衰竭（HF）或曾因 HF 住院</b>
        <div class="small">你流程：CKD/蛋白尿/HF → Step2 優先 SGLT2。</div>
      </div>
    </div>

    <hr class="sep">

    <div class="sectionTitle">② 目前主力方案（你門診的「目前用藥」）</div>

    <div class="formRow">
      <div>
        <label>目前主力方案</label>
        <select id="stage" onchange="syncStageUI()">
          <option value="s1" selected>Step1：Metformin alone</option>
          <option value="s2_sglt2">Step2：Metformin + SGLT2i</option>
          <option value="s2_dpp4">Step2：Metformin + DPP4i</option>
          <option value="s2_tzd">Step2：Metformin + TZD</option>
          <option value="s_combo">目前用藥：Metformin +（SGLT2i + DPP4i 固定複方）</option>
          <option value="s_insulin">（Step4評估可用）Metformin + Insulin</option>
        </select>
        <div class="small">你說多數情境是：<b>Metformin +（SGLT2/DPP4 複方）</b>，此選項已按此假設設計。</div>
      </div>
      <div id="insulinBox" class="hidden">
        <label>Insulin 每日總劑量（U/day）</label>
        <input id="insulinU" type="number" min="0" max="500" step="1" placeholder="例：24">
        <div class="small">Step4/GLP-1 評估時自動判斷是否 <b>&lt;60U/day</b>。</div>
      </div>
    </div>

    <div class="chips" style="margin-top:8px;">
      <label class="chip"><input type="checkbox" id="addSU"> 期間加用 SU（可）</label>
      <label class="chip"><input type="checkbox" id="addAcarb"> 期間加用 Acarbose（可）</label>
    </div>

    <hr class="sep">

    <div class="sectionTitle">③ GLP-1 模組（可選；需要評估再展開）</div>
    <div class="btnRow">
      <button id="toggleGlp1Btn" onclick="toggleGlp1()">展開/收起 GLP-1 評估</button>
    </div>

    <div id="glp1Panel" style="display:none; margin-top:10px;" class="flowBox">
      <div class="small" style="margin-bottom:8px;">
        只有你要判斷「是否可改 GLP-1」時才需要填。若院所沒有此藥，可完全不使用。
      </div>

      <div class="formRow">
        <div>
          <label>是否已併用（當前方案）滿 6 個月？</label>
          <select id="glp1_6m">
            <option value="unknown" selected>不確定/未記載</option>
            <option value="yes">是（≥6 個月）</option>
            <option value="no">否</option>
          </select>
        </div>
        <div>
          <label>第六個月 HbA1c 是否仍 &gt; 8.0%？</label>
          <select id="glp1_a1c8">
            <option value="unknown" selected>不確定</option>
            <option value="yes">是（&gt;8.0%）</option>
            <option value="no">否</option>
          </select>
        </div>
      </div>

      <div class="formRow">
        <div>
          <label>你是否會在改 GLP-1 後「停用 DPP-4 / SGLT2」？</label>
          <select id="glp1_stop_dpp4_sglt2">
            <option value="unknown" selected>不確定</option>
            <option value="yes">會停（較符合常見併用限制）</option>
            <option value="no">不會停（可能不符/需改策略）</option>
          </select>
        </div>
        <div>
          <label>顯示「GLP-1 健保 + SGLT2 自費」策略提示</label>
          <select id="glp1_selfpay_hint">
            <option value="yes" selected>要</option>
            <option value="no">不要</option>
          </select>
        </div>
      </div>
    </div>

    <div class="btnRow">
      <button class="primary" onclick="run()">產生建議</button>
      <button onclick="resetAll()">清除</button>
    </div>
  </section>

  <!-- 右：輸出 -->
  <section class="card">
    <div class="sectionTitle">④ 你的流程（Step 1→4，門診版）</div>
    <div class="flowBox">
      <div class="flowStep">
        <span class="pill">Step1</span>
        Metformin（<b>≥1000 mg/day</b> 視為 maximum）→ 3 個月後若 A1c &gt;7 → Step2
      </div>
      <div class="flowStep">
        <span class="pill">Step2</span>
        Metformin +（SGLT2i 優先：CKD/蛋白尿/HF）/ DPP4（第二優先）/ TZD
      </div>
      <div class="flowStep">
        <span class="pill">Step3</span>
        Metformin max +（SGLT2 或 DPP4）≥6 個月，且第 6 個月 A1c &gt;7.5 → 改固定複方（SGLT2+DPP4）
      </div>
      <div class="flowStep">
        <span class="pill">Step4</span>
        Metformin max 併用（SGLT2 / DPP4 / 固定複方 / insulin <b>&lt;60U/day</b>）≥6 個月且第 6 個月 A1c &gt;8 → 可評估改 GLP-1（可選模組）
      </div>
      <div class="small" style="margin-top:8px;">
        期間可加 SU 或 Acarbose 加強，但口服成分上限 ≤4（複方算兩種）。
      </div>
    </div>

    <div class="sectionTitle" style="margin-top:14px;">⑤ 輸出：建議用藥 × 健保/適用性（含替代方案）</div>
    <div id="summary" class="muted" style="margin-bottom:10px;">
      按「產生建議」後，這裡會顯示摘要。
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width:52%;">建議用藥（依 Step 流程）＋替代方案</th>
            <th style="width:48%;">健保/適用性（核對與缺項）</th>
          </tr>
        </thead>
        <tbody id="outRows">
          <tr><td class="muted">尚未產生結果</td><td class="muted">—</td></tr>
        </tbody>
      </table>
    </div>

    <div class="inlineHint small">
      你現在這版已加入：<b>Metformin eGFR 限制提醒</b>（與你固定 1000mg maximum 的門診流程一起顯示）。
      若你想，我可以再加「一鍵複製病歷句」。
    </div>
  </section>
</main>

<script>
  function valNum(id){
    const v = document.getElementById(id).value;
    if(v === "" || v === null || v === undefined) return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }
  function sel(id){ return document.getElementById(id).value; }
  function checked(id){ return document.getElementById(id).checked; }

  function badge(type, text){
    const cls = type === "ok" ? "status ok" : type === "warn" ? "status warn" : "status bad";
    return `<span class="${cls}">${text}</span>`;
  }
  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }
  function addRow(rows, leftHtml, statusType, statusText, rightDetail){
    rows.push(`
      <tr>
        <td>${leftHtml}</td>
        <td>
          ${badge(statusType, statusText)}
          <div class="small" style="margin-top:8px;">${rightDetail}</div>
        </td>
      </tr>
    `);
  }

  function syncStageUI(){
    const st = sel("stage");
    const box = document.getElementById("insulinBox");
    box.classList.toggle("hidden", st !== "s_insulin");
  }
  syncStageUI();

  function toggleGlp1(){
    const p = document.getElementById("glp1Panel");
    p.style.display = (p.style.display === "none") ? "block" : "none";
  }

  // Metformin kidney reminders (simplified)
  // Common practice summary:
  // - eGFR <30: avoid / stop
  // - eGFR 30–44: generally avoid initiating; if continuing, reduce dose (often ≤1000 mg/day) + monitor
  // - eGFR ≥45: generally ok
  function metforminEgfrAdvice(egfr, metDose){
    if(egfr === null){
      return {level:"warn", title:"需輸入 eGFR", detail:"未輸入 eGFR，無法判斷 metformin 的腎功能限制。"};
    }
    const e = egfr;
    if(e < 30){
      return {
        level:"bad",
        title:"eGFR <30：不建議使用/需停用",
        detail:"一般建議 eGFR <30 避免或停用 metformin（乳酸中毒風險）。"
      };
    }
    if(e < 45){
      let doseMsg = "eGFR 30–44：多數情況不建議新開始；若已在用，常見作法是降劑量（例如 ≤1000 mg/day）並加密監測。";
      if(metDose !== null && metDose > 1000){
        doseMsg += "（目前劑量 >1000：建議評估下修）";
      }
      return {level:"warn", title:"eGFR 30–44：需慎用/考慮降劑量", detail:doseMsg};
    }
    return {level:"ok", title:"eGFR ≥45：通常可用", detail:"eGFR ≥45 多數情況可安全使用（仍需定期追蹤腎功能）。"};
  }

  // SGLT2 eGFR suitability reminders (simplified)
  function sglt2EgfrAdvice(agent, egfr){
    if(agent === "none") return {level:"ok", title:"未評估 SGLT2 品項", detail:"—"};
    if(egfr === null) return {level:"warn", title:"需輸入 eGFR", detail:"未輸入 eGFR，無法做 SGLT2 適用性提醒。"};
    const e = egfr;

    if(agent === "cana"){
      if(e < 30) return {level:"bad", title:"不建議（eGFR <30）", detail:"Canagliflozin：eGFR <30 通常不建議使用/開始。"};
      if(e < 60) return {level:"warn", title:"可用但需注意劑量", detail:"Canagliflozin：eGFR 30–59 常見建議 100 mg/day（依仿單/院內規範）。"};
      return {level:"ok", title:"可用", detail:"Canagliflozin：eGFR ≥60 通常可用。"};
    }
    if(agent === "dapa"){
      if(e < 25) return {level:"bad", title:"不建議開始（eGFR <25）", detail:"Dapagliflozin：eGFR <25 通常不建議新開始；是否續用依仿單/臨床判斷。"};
      return {level:"ok", title:"可用", detail:"Dapagliflozin：eGFR ≥25 通常可用（依仿單）。"};
    }
    if(agent === "empa"){
      if(e < 30) return {level:"bad", title:"不建議（eGFR <30）", detail:"Empagliflozin：eGFR <30 通常不建議使用/開始（依仿單）。"};
      return {level:"ok", title:"可用", detail:"Empagliflozin：eGFR ≥30 通常可用（依仿單）。"};
    }
    if(agent === "ertu"){
      if(e < 30) return {level:"bad", title:"不建議（eGFR <30）", detail:"Ertugliflozin：eGFR <30 通常不建議使用。"};
      if(e < 45) return {level:"warn", title:"一般不建議開始（eGFR 30–44）", detail:"Ertugliflozin：eGFR <45 多數情況不建議開始；是否續用依仿單/臨床判斷。"};
      return {level:"ok", title:"可用", detail:"Ertugliflozin：eGFR ≥45 通常可用。"};
    }
    if(agent === "combo45"){
      if(e < 45) return {level:"bad", title:"複方多不適用（eGFR <45）", detail:"SGLT2+Metformin 複方：多數仿單建議需 eGFR ≥45。"};
      return {level:"ok", title:"複方可考慮", detail:"SGLT2+Metformin 複方：eGFR ≥45 多數情況可用（仍以仿單為準）。"};
    }
    return {level:"warn", title:"未知品項", detail:"請選擇 SGLT2 品項。"};
  }

  function run(){
    const a1c = valNum("a1c");
    const months = valNum("monthsOnStage");
    const egfr = valNum("egfr");
    const metDose = valNum("metDose");
    const oralComponents = valNum("oralComponents");
    const sglt2Agent = sel("sglt2Agent");
    const stage = sel("stage");
    const insulinU = valNum("insulinU");

    const ckd = checked("ckd");
    const hf = checked("hf");
    const addSU = checked("addSU");
    const addAcarb = checked("addAcarb");

    const glp1PanelOpen = (document.getElementById("glp1Panel").style.display !== "none");
    const glp1_6m = sel("glp1_6m");
    const glp1_a1c8 = sel("glp1_a1c8");
    const glp1_stop = sel("glp1_stop_dpp4_sglt2");
    const glp1_selfpay = sel("glp1_selfpay_hint");

    // Your fixed clinic rules
    const metMaxClinic = (metDose !== null && metDose >= 1000);
    const step2Trigger = (a1c !== null && months !== null && months >= 3 && a1c > 7.0);
    const step3Trigger = (a1c !== null && months !== null && months >= 6 && a1c > 7.5);
    const step4Trigger = (a1c !== null && months !== null && months >= 6 && a1c > 8.0);

    // Insulin <60
    const insulinLt60 = (insulinU !== null && insulinU > 0 && insulinU < 60);

    // Summary
    const bits = [];
    if(a1c !== null) bits.push(`HbA1c：<b>${a1c.toFixed(1)}%</b>`);
    if(months !== null) bits.push(`本階段：<b>${months.toFixed(0)}月</b>`);
    if(egfr !== null) bits.push(`eGFR：<b>${egfr.toFixed(0)}</b>`);
    if(metDose !== null) bits.push(`Metformin：<b>${metDose.toFixed(0)} mg/day</b>`);
    if(stage === "s_insulin" && insulinU !== null) bits.push(`Insulin：<b>${insulinU.toFixed(0)} U/day</b>`);
    if(ckd) bits.push(`<b>CKD/蛋白尿</b>`);
    if(hf) bits.push(`<b>HF</b>`);
    if(addSU) bits.push(`<b>+SU</b>`);
    if(addAcarb) bits.push(`<b>+Acarbose</b>`);
    document.getElementById("summary").innerHTML = bits.length ? bits.join(" · ") : "（尚未輸入摘要資料）";

    const rows = [];

    // Missing basics
    if(a1c === null) addRow(rows, `<b>缺 HbA1c</b>`, "warn", "⚠️ 缺資料", `請輸入 HbA1c 才能跑 Step 觸發條件。`);
    if(months === null) addRow(rows, `<b>缺本階段月數</b>`, "warn", "⚠️ 缺資料", `你的流程依 3/6 個月判斷。`);
    if(metDose === null) addRow(rows, `<b>缺 metformin 劑量</b>`, "warn", "⚠️ 缺資料", `你的流程以 ≥1000 mg/day 當 maximum（但也要看 eGFR 限制）。`);
    if(egfr === null) addRow(rows, `<b>缺 eGFR</b>`, "warn", "⚠️ 缺資料", `你要求要提醒 metformin / SGLT2 的腎功能限制，請輸入 eGFR。`);

    // Oral components
    if(oralComponents === null){
      addRow(rows, `<b>口服成分數未填</b>`, "warn", "⚠️ 無法判定", `健保原則：口服成分 ≤4（複方算兩種）。`);
    } else if(oralComponents > 4){
      addRow(rows, `<b>口服成分數=${oralComponents}</b>（>4）`, "bad", "❌ 可能不符", `建議先精簡口服或改注射策略，以免踩到口服成分上限。`);
    } else {
      addRow(rows, `<b>口服成分數=${oralComponents}</b>（≤4）`, "ok", "✅ OK", `符合口服成分上限原則。`);
    }

    // Metformin eGFR reminder
    const metEgfr = metforminEgfrAdvice(egfr, metDose);
    addRow(
      rows,
      `<b>Metformin 腎功能限制提醒</b>`,
      metEgfr.level,
      metEgfr.level === "ok" ? "✅ OK" : metEgfr.level === "warn" ? "⚠️ 注意" : "❌ 不適用",
      `${escapeHtml(metEgfr.title)}<br/>${escapeHtml(metEgfr.detail)}`
    );

    // Metformin max per your rule (but annotate if eGFR restricts)
    if(metDose !== null){
      let statusType = metMaxClinic ? "ok" : "warn";
      let statusText = metMaxClinic ? "✅ 達到（門診定義）" : "⚠️ 未達到（門診定義）";
      let detail = `你的流程固定：≥1000 mg/day 視為 maximum。`;

      if(egfr !== null && egfr < 45){
        statusType = (egfr < 30) ? "bad" : "warn";
        statusText = (egfr < 30) ? "❌ 受 eGFR 限制" : "⚠️ 受 eGFR 限制";
        detail += `<br/>但目前 eGFR <45，metformin 劑量/是否可用需依腎功能調整（上方已提示）。`;
      }
      addRow(
        rows,
        `<b>Metformin maximum（你的門診定義）</b>：${metDose} mg/day → ${metMaxClinic ? "達到" : "未達到"}`,
        statusType,
        statusText,
        detail
      );
    }

    // SGLT2 eGFR reminder if selected
    if(sglt2Agent !== "none"){
      const sAdv = sglt2EgfrAdvice(sglt2Agent, egfr);
      addRow(
        rows,
        `<b>SGLT2 eGFR 適用性</b><br/>你選的品項：<code>${escapeHtml(document.getElementById("sglt2Agent").selectedOptions[0].text)}</code>`,
        sAdv.level,
        sAdv.level === "ok" ? "✅ 可用/可考慮" : sAdv.level === "warn" ? "⚠️ 注意" : "❌ 不適用",
        `${escapeHtml(sAdv.title)}<br/>${escapeHtml(sAdv.detail)}`
      );
    } else {
      addRow(rows, `<b>SGLT2 eGFR 適用性</b>`, "ok", "✅ 未評估", `未選擇 SGLT2 品項（如需心腎導向可再選）。`);
    }

    // Alternatives helper
    function alternativesForStep2(){
      const prefer = (ckd || hf) ? "優先：SGLT2i（CKD/蛋白尿/HF）" : "第二優先：DPP-4i；或 TZD";
      const alt = (ckd || hf)
        ? "替代方案：若 eGFR/不耐受使 SGLT2 不適用 → 改 DPP-4i（或 TZD 視情況）"
        : "替代方案：若擔心體重/水腫/心衰風險 → 優先 DPP-4i；若需強效但可接受副作用 → 考慮 TZD / 加 SU / Acarbose（注意成分≤4）";
      return {prefer, alt};
    }

    // STEP OUTPUTS
    if(stage === "s1"){
      const left = `<b>目前：Step1（Metformin alone）</b><br/>
      觸發條件：已用 ≥3月 且 HbA1c &gt;7 → 進 Step2 加一個主力。<br/>
      <div class="small" style="margin-top:8px;">
        <b>替代方案：</b>若還沒達 3 月/或 A1c ≤7 → 維持並加強生活型態；必要時可先加 SU/Acarbose（注意成分上限）。
      </div>`;

      if(step2Trigger){
        const {prefer, alt} = alternativesForStep2();
        let statusType = metMaxClinic ? "ok" : "warn";
        let statusText = metMaxClinic ? "✅ 建議進 Step2" : "⚠️ 可進 Step2 但先把 metformin 拉到 1000";
        let detail = `已達 Step2 觸發（≥3月 且 A1c &gt;7）。<br/>
          <b>建議：</b>${escapeHtml(prefer)}<br/>
          <b>替代方案：</b>${escapeHtml(alt)}<br/>
          健保提醒：多數條文用語為「最大耐受 metformin 後仍控制不佳」。`;

        if(egfr !== null && egfr < 30){
          statusType = "bad";
          statusText = "❌ eGFR <30：metformin 受限";
          detail += `<br/><br/><b>重要：</b>你雖觸發升階，但 metformin 在 eGFR <30 通常不建議使用/需停用，請先依腎功能調整基礎治療。`;
        }

        addRow(rows, left, statusType, statusText, detail);
      } else {
        addRow(rows, left, "ok", "✅ 尚未觸發", `尚未符合 Step2 觸發（需 ≥3月 且 A1c &gt;7）。`);
      }
    }

    if(stage === "s2_sglt2" || stage === "s2_dpp4" || stage === "s2_tzd"){
      const now = stage === "s2_sglt2" ? "Metformin + SGLT2i"
                : stage === "s2_dpp4" ? "Metformin + DPP-4i"
                : "Metformin + TZD";

      const left2 = `<b>目前：Step2（${now}）</b><br/>
      觸發 Step3：Metformin max +（SGLT2 或 DPP4）≥6月 且 第6個月 A1c &gt;7.5 → Step3 固定複方（SGLT2+DPP4）。<br/>
      <div class="small" style="margin-top:8px;">
        <b>替代方案：</b>若尚未滿 6 月或 A1c ≤7.5 → 維持並優化（可加 SU/Acarbose 但注意成分≤4）；若 SGLT2 不適用 → 改走 DPP4/TZD。
      </div>`;

      if(step3Trigger){
        const step3Eligible = (stage === "s2_sglt2" || stage === "s2_dpp4");
        if(!step3Eligible){
          addRow(
            rows,
            left2,
            "warn",
            "⚠️ 你目前是 TZD，與 Step3 前提不一致",
            `你貼的流程 Step3 前提是「Metformin max +（SGLT2 或 DPP4）≥6月」。<br/>
            <b>替代方案：</b>若目前走 TZD 且控制不佳，可先轉回你 Step2 的主路徑（SGLT2 或 DPP4），再按 6 月規則評估固定複方。`
          );
        } else {
          addRow(
            rows,
            left2,
            "warn",
            "⚠️ 觸發 Step3（門診流程）",
            `已達 Step3 觸發（≥6月 且 A1c &gt;7.5）。<br/>
            <b>建議（你的流程）：</b>改固定複方（SGLT2 + DPP4）。<br/>
            <b>替代方案：</b>若院所申報/實務不想走固定複方 → 維持單一主力（SGLT2 或 DPP4）並加 SU/Acarbose（注意成分≤4）或考慮注射策略。`
          );
        }
      } else {
        addRow(rows, left2, "ok", "✅ 尚未觸發 Step3", `尚未達 Step3 觸發（需 ≥6月 且 A1c &gt;7.5）。`);
      }

      const left4 = `<b>Step4（可選 GLP-1 模組）</b><br/>
      觸發：Metformin max 併用（SGLT2/DPP4/固定複方/insulin &lt;60U/day）≥6月 且 A1c &gt;8 → 可評估 GLP-1。<br/>
      <div class="small" style="margin-top:8px;">
        <b>替代方案：</b>若院所無 GLP-1 → 走注射胰島素強化或調整既有口服（注意成分≤4）。
      </div>`;
      addRow(rows, left4, step4Trigger ? "warn" : "ok", step4Trigger ? "⚠️ 可評估" : "✅ 尚未觸發", step4Trigger ? `你目前符合 Step4 觸發（依你流程）。若要判斷是否可改 GLP-1，請展開 GLP-1 模組填寫。` : `未達 Step4 觸發（需 ≥6月 且 A1c &gt;8）。`);
    }

    if(stage === "s_combo"){
      // Your common scenario: Metformin + (SGLT2+DPP4 fixed combo)
      const left = `<b>目前：Metformin + 固定複方（SGLT2 + DPP4）</b><br/>
      （本工具對此選項的預設：<b>多數情境一定有併用 Metformin</b>）<br/>
      觸發 Step4：併用 ≥6月 且 第6個月 A1c &gt;8 → 可評估改 GLP-1（可選模組）。<br/>
      <div class="small" style="margin-top:8px;">
        <b>替代方案：</b>若 GLP-1 不可得 → 考慮注射胰島素策略；或回到單一主力（SGLT2 或 DPP4）搭配 SU/Acarbose（注意成分≤4）。
      </div>`;

      // Reinforce metformin entry + kidney limits
      if(metDose === null){
        addRow(rows, `<b>目前選擇：Metformin + 固定複方</b>`, "warn", "⚠️ 缺資料",
          "你選了「Metformin + 固定複方」，但尚未填 Metformin 劑量。請填入（你的流程定義 maximum：≥1000 mg/day；且要注意 eGFR 限制）。"
        );
      } else if(metDose < 1000){
        addRow(rows, `<b>目前選擇：Metformin + 固定複方</b>`, "warn", "⚠️ Metformin 未達 1000",
          "你門診流程把 ≥1000 mg/day 視為 maximum。若病人耐受且 eGFR 允許，建議先把 Metformin 拉到 1000 再判斷是否升階/改注射策略。"
        );
      }
      if(egfr !== null && egfr < 30){
        addRow(rows, left, "bad", "❌ metformin 受限（eGFR <30）",
          "你目前流程是以 Metformin 為基底，但 eGFR <30 時 metformin 通常不建議使用/需停用。請先依腎功能調整基礎治療，再走後續路徑。"
        );
      } else {
        addRow(rows, left, step4Trigger ? "warn" : "ok", step4Trigger ? "⚠️ 可評估 Step4" : "✅ 尚未觸發 Step4",
          step4Trigger
          ? "你目前符合 Step4 觸發（≥6月 且 A1c >8）。若要評估 GLP-1，請展開 GLP-1 模組。"
          : "未達 Step4 觸發（需 ≥6月 且 A1c >8）。"
        );
      }
    }

    if(stage === "s_insulin"){
      const left = `<b>目前：Metformin + Insulin</b><br/>
      Step4/GLP-1 路徑會用「Insulin &lt;60U/day」作為其中一個條件。<br/>
      <div class="small" style="margin-top:8px;">
        <b>替代方案：</b>若 insulin ≥60U/day，通常代表已較強化治療；可先優化胰島素策略/依血糖型態調整，並評估是否還有口服藥可簡化。
      </div>`;

      if(insulinU === null){
        addRow(rows, left, "warn", "⚠️ 缺資料", `請輸入 Insulin U/day 才能判斷是否符合「<60」條件。`);
      } else {
        addRow(
          rows,
          left,
          insulinLt60 ? "ok" : "warn",
          insulinLt60 ? "✅ <60U/day" : "⚠️ ≥60U/day",
          insulinLt60
            ? `Insulin <60U/day，符合你 Step4 的其中一個路徑條件（仍需 ≥6月 且 A1c >8）。`
            : `Insulin ≥60U/day，可能不符合你 Step4 的「<60」路徑；但仍可依臨床與院內規範決策。`
        );
      }

      const left4 = `<b>Step4（可選 GLP-1 模組）</b><br/>觸發：≥6月 且 A1c &gt;8，且若走 insulin 路徑通常需 insulin &lt;60U/day。`;
      addRow(
        rows,
        left4,
        (step4Trigger && insulinLt60) ? "warn" : "ok",
        (step4Trigger && insulinLt60) ? "⚠️ 可評估" : "✅ 尚未滿足完整條件",
        (step4Trigger && insulinLt60)
          ? `你目前符合（≥6月、A1c &gt;8、insulin &lt;60）→ 可展開 GLP-1 模組做檢核。`
          : `若要走此路徑，需要同時滿足：≥6月、A1c &gt;8、insulin &lt;60U/day。`
      );
    }

    // GLP-1 module evaluation (optional)
    if(glp1PanelOpen){
      const missing = [];
      let ok = true;

      if(glp1_6m !== "yes"){ ok = false; missing.push("需確認是否已併用滿 6 個月"); }
      if(glp1_a1c8 !== "yes"){ ok = false; missing.push("需確認第六個月 HbA1c 是否仍 >8.0%"); }
      if(glp1_stop !== "yes"){ ok = false; missing.push("若改 GLP-1，通常需停用 DPP-4 / SGLT2（否則可能不符/需改策略）"); }

      if(stage === "s_insulin"){
        if(insulinU === null){ ok = false; missing.push("Insulin U/day 未填（需判斷是否 <60）"); }
        else if(!insulinLt60){ ok = false; missing.push("Insulin ≥60U/day（不符合你 Step4 的 insulin 路徑條件）"); }
      }

      if(ok){
        const hint = (glp1_selfpay === "yes")
          ? `<br/><br/><b>臨床策略提示（非健保建議）：</b>若你希望保留心腎保護效果且病人可接受，可考慮「GLP-1 走健保、SGLT2 自費」之組合策略（請明確告知費用、併用風險/利益與追蹤計畫）。`
          : ``;

        addRow(
          rows,
          `<b>GLP-1 評估（你已展開填寫）</b>：符合你 Step4 的進入條件（第一版）。<br/>
           <div class="small" style="margin-top:8px;"><b>替代方案：</b>若 GLP-1 不可得或病人不接受 → 改走胰島素強化/調整，或回到單一主力 + 加強口服（注意成分≤4）。</div>`,
          "ok",
          "✅ 可進一步評估",
          `你填寫已符合：≥6月、A1c &gt;8、且併用策略可避免與 DPP-4/SGLT2 同時使用。${hint}`
        );
      } else {
        addRow(
          rows,
          `<b>GLP-1 評估（你已展開）</b>：目前資料不足或條件未滿足。`,
          "warn",
          "⚠️ 需補資料/調整",
          `缺項/衝突：<ul style="margin:6px 0 0 18px;">${missing.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>`
        );
      }
    } else {
      addRow(rows, `<b>GLP-1 模組</b>：目前收起（未評估）`, "ok", "✅ 略過", `需要評估時再展開即可。`);
    }

    document.getElementById("outRows").innerHTML = rows.join("");
  }

  function resetAll(){
    const ids = ["a1c","monthsOnStage","egfr","metDose","oralComponents","sglt2Agent","stage","insulinU",
                 "ckd","hf","addSU","addAcarb",
                 "glp1_6m","glp1_a1c8","glp1_stop_dpp4_sglt2","glp1_selfpay_hint"];
    for(const id of ids){
      const el = document.getElementById(id);
      if(!el) continue;
      if(el.type === "checkbox") el.checked = false;
      else if(el.tagName === "SELECT"){
        if(id === "stage") el.value = "s1";
        else if(id === "glp1_selfpay_hint") el.value = "yes";
        else el.selectedIndex = 0;
      } else el.value = "";
    }
    document.getElementById("glp1Panel").style.display = "none";
    syncStageUI();
    document.getElementById("summary").innerHTML = "按「產生建議」後，這裡會顯示摘要。";
    document.getElementById("outRows").innerHTML = `<tr><td class="muted">尚未產生結果</td><td class="muted">—</td></tr>`;
  }
</script>
</body>
</html>
